name: Coverage
on:
  workflow_run:
    workflows: ["Build"]
    types: [completed]
jobs:
  coverage:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: "1.25"

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install web dependencies
        run: cd web && npm ci

      - name: Run Go tests with coverage
        run: cd engine && go test ./... -coverpkg=./... -coverprofile=cover.out

      - name: Run web tests with coverage
        run: cd web && npm run test:coverage

      - name: Normalize web coverage paths
        run: cd web && sed -i "s|^SF:|SF:web/|" coverage/lcov.info

      - name: Upload combined coverage to Qlty
        uses: qltysh/qlty-action/coverage@v1
        with:
          token: ${{ secrets.QLTY_COVERAGE_TOKEN }}
          strip-prefix: |
            github.com/kode4food/argyll/
          files: |
            engine/cover.out
            web/coverage/lcov.info
