name: Build
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
jobs:
  build-engine:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: "1.25"
      - name: Build and Test Engine
        run: cd engine && make

  build-go-sdk:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: "1.25"
      - name: Build and Test Go SDK
        run: cd sdks/go-builder && make

  build-python-sdk:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Set up Go
        uses: actions/setup-python@v6
        with:
          python-version: "3.9"
      - name: Build and Test Python SDK
        run: cd sdks/python && make test

  build-web:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
      - name: Install dependencies
        run: cd web && npm ci
      - name: Type check
        run: cd web && npm run type-check
      - name: Build web app
        run: cd web && npm run build
      - name: Run tests
        run: cd web && npm test

  coverage:
    runs-on: ubuntu-latest
    needs: [build-engine, build-go-sdk, build-web]
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: "1.25"

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install web dependencies
        run: cd web && npm ci

      - name: Run Engine tests with coverage
        run: cd engine && go test ./... -coverpkg=./... -coverprofile=cover.out

      - name: Run Go SDK tests with coverage
        run: cd sdks/go-builder && go test ./... -coverpkg=./... -coverprofile=cover.out

      - name: Run web tests with coverage
        run: cd web && npm run test:coverage

      - name: Normalize web coverage paths
        run: cd web && sed -i "s|^SF:|SF:web/|" coverage/lcov.info

      - name: Upload combined coverage to Qlty
        uses: qltysh/qlty-action/coverage@v1
        with:
          token: ${{ secrets.QLTY_COVERAGE_TOKEN }}
          strip-prefix: |
            github.com/kode4food/argyll/
          files: |
            engine/cover.out
            sdks/go-builder/cover.out
            web/coverage/lcov.info
