openapi: 3.0.3
info:
  title: Argyll Step Interface Contract
  description: |
    This specification defines the contract that external flow steps must implement
    to work with the Argyll orchestrator.

    ## Overview

    A "step" in Argyll is any HTTP endpoint that accepts flow state, processes it
    according to its business logic, and returns outputs. Steps can be:

    - **Dedicated microservices** with a single endpoint
    - **Multiple endpoints** on a larger service
    - **Functions-as-a-Service** (AWS Lambda, Azure Functions, Google Cloud Functions, etc.)
    - **Legacy systems** with interface adapters
    - **Any HTTP endpoint** that conforms to this contract

    ## Step Types

    Steps can be classified into four execution patterns:

    ### Sync Steps
    - Return results immediately in the HTTP response
    - Best for: Fast operations (< 30 seconds)
    - Example: Text processing, validation, simple transformations

    ### Async Steps
    - Return immediately with HTTP 200
    - Complete later via webhook callback to the engine
    - Best for: Long-running operations (> 30 seconds)
    - Example: Video encoding, batch processing, external API calls

    ### Script Steps
    - Ale or Lua scripts executed directly in the engine
    - Not HTTP-based (no external endpoint required)
    - Best for: Simple transformations, data mapping, conditional logic

    ### Flow Steps
    - Sub-flows executed by the engine with child flow goals
    - Not HTTP-based (no external endpoint required)
    - Best for: Encapsulating reusable sub-flows with attribute mappings

    **Note**: This specification covers only HTTP-based steps (sync and async).
    Script and flow steps are defined directly in the step registration.

    ## Request/Response Contract

    All HTTP steps must implement a `POST` endpoint that:

    1. **Accepts** a JSON request with:
       - `arguments`: Input arguments (from flow state)
       - `metadata`: Flow context (flow_id, step_id, receipt_token, etc.)

    2. **Returns** a JSON response with:
       - `success`: Boolean indicating execution success
       - `outputs`: Key-value pairs for declared output attributes (if success=true)
       - `error`: Optional error message (if success=false)

    ## Error Handling

    Steps should distinguish between:

    - **Business logic errors** (`success: false`, `error: "message"`):
      - The step executed correctly but the business logic failed
      - Example: Validation failed, invalid input format, etc.
      - The step is marked as failed (the flow fails if this blocks goals)

    - **HTTP errors** (4xx/5xx status codes):
      - Infrastructure or request format errors
      - Example: Missing required arguments, internal server error, etc.
      - 4xx responses are treated as permanent failures (no retry)
      - 5xx responses are treated as retryable failures

    ## Deployment Flexibility

    Steps can be deployed anywhere that can receive HTTP requests:

    - **Containers**: Docker, Kubernetes, ECS, etc.
    - **Serverless**: AWS Lambda, Azure Functions, Google Cloud Functions
    - **Traditional servers**: VMs, bare metal, etc.
    - **Platform services**: Heroku, Render, Railway, etc.

    The Argyll engine only requires that your step endpoint is reachable via HTTP/HTTPS.

  version: 1.0.0
  contact:
    name: Argyll Engine
    url: https://github.com/kode4food/argyll
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: "{protocol}://{host}:{port}"
    description: Your step endpoint server (configurable)
    variables:
      protocol:
        enum: [http, https]
        default: http
      host:
        default: localhost
        description: Your step server hostname or IP
      port:
        default: "8081"
        description: Your step server port

paths:
  /{stepEndpoint}:
    post:
      summary: Execute Step
      description: |
        Execute this step with the provided arguments and flow context.

        ## Implementation Guidelines

        Your step implementation should:

        1. **Validate inputs**: Check that all required arguments are present
        2. **Process the request**: Execute your business logic
        3. **Return results**: Provide outputs or error information
        4. **Handle timeouts**: Respect the timeout configured in step registration
        5. **Use idempotency**: Use `flow_id` + `step_id` + `receipt_token` from metadata as idempotency key

        ## Execution Flow

        **For Sync Steps:**
        1. Receive request from engine
        2. Process immediately
        3. Return response with outputs
        4. Engine maps declared outputs into flow state

        **For Async Steps:**
        1. Receive request from engine
        2. Return HTTP 200 immediately (engine provides webhook URL in request)
        3. Process asynchronously in background
        4. POST results to webhook when complete
        5. Engine maps declared outputs into flow state

        ## Terminal Steps

        Goal steps (steps that are specified as flow goals) naturally complete
        the flow when they finish successfully. The flow ends when all goal
        steps have completed.

      operationId: executeStep
      tags:
        - Step Execution
      parameters:
        - name: stepEndpoint
          in: path
          required: true
          description: Your step's endpoint path (configured in step registration)
          schema:
            type: string
            example: process-text
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/StepRequest"
            examples:
              simpleProcessor:
                summary: Simple text processing
                description: A step that transforms text to uppercase
                value:
                  arguments:
                    input_text: "Hello World"
                    format: "uppercase"
                  metadata:
                    flow_id: "wf-123"
                    step_id: "text-processor"
                    receipt_token: "tok_abc123xyz"
              validationStep:
                summary: User validation
                description: A step that validates user permissions
                value:
                  arguments:
                    user_id: "john.doe@company.com"
                    required_role: "admin"
                  metadata:
                    flow_id: "wf-onboarding-789"
                    step_id: "user-validator"
                    receipt_token: "tok_def456uvw"
              dataEnrichment:
                summary: Data enrichment
                description: A step that enriches data with external API
                value:
                  arguments:
                    user_id: "12345"
                    enrich_fields: ["profile", "preferences", "activity"]
                  metadata:
                    flow_id: "wf-analytics-456"
                    step_id: "data-enricher"
                    receipt_token: "tok_ghi789rst"
      responses:
        "200":
          description: Step executed successfully (or failed with business logic error)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/StepResponse"
              examples:
                successWithOutputs:
                  summary: Successful execution with outputs
                  description: Step processed successfully and produced outputs
                  value:
                    success: true
                    outputs:
                      processed_text: "HELLO WORLD"
                      character_count: 11
                      processing_time_ms: 15
                successMultipleOutputs:
                  summary: Multiple outputs
                  description: Step producing multiple named outputs
                  value:
                    success: true
                    outputs:
                      user_profile:
                        user_id: "john.doe"
                        email: "john@example.com"
                        created_at: "2023-01-15"
                      user_permissions: ["read", "write", "admin"]
                      validation_status: "approved"
                businessError:
                  summary: Business logic error
                  description: Step executed but business logic failed
                  value:
                    success: false
                    error: "Invalid input format: 'format' must be one of [uppercase, lowercase, titlecase]"
        "400":
          description: |
            Bad request - Invalid request format or missing required arguments.
            This indicates a problem with the request itself, not business logic.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                missingArgument:
                  summary: Missing required argument
                  value:
                    error: "Missing required argument: input_text"
                    code: "MISSING_REQUIRED_ARG"
                invalidFormat:
                  summary: Invalid request format
                  value:
                    error: "Invalid JSON in request body"
                    code: "INVALID_JSON"
        "500":
          description: |
            Internal server error - Unexpected error during step execution.
            The engine will fail the step and may retry depending on configuration.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                internalError:
                  summary: Internal server error
                  value:
                    error: "Internal server error: database connection failed"
                    code: "INTERNAL_ERROR"
        "503":
          description: |
            Service unavailable - Step temporarily cannot process requests.
            The engine will fail the step and may retry depending on configuration.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                serviceUnavailable:
                  summary: Service unavailable
                  value:
                    error: "Service temporarily unavailable: maintenance in progress"
                    code: "SERVICE_UNAVAILABLE"

components:
  schemas:
    StepRequest:
      type: object
      required:
        - arguments
        - metadata
      properties:
        arguments:
          type: object
          description: |
            Input arguments for this step execution. This object contains:
            - All **required arguments** (as defined in step registration)
            - Any **optional arguments** that are available
            - Values from the flow state that match declared inputs

            Your step should validate that all required arguments are present.
          additionalProperties: true
          example:
            input_text: "Hello World"
            format: "uppercase"
            timeout_seconds: 30
        metadata:
          type: object
          description: |
            Additional flow context and metadata. This provides contextual
            information but should NOT be used for core business logic.

            **Standard fields provided by the engine:**
            - `flow_id`: The executing flow's ID (use for idempotency)
            - `step_id`: The step identifier being executed
            - `receipt_token`: Unique work-item token for idempotency
            - `webhook_url`: For async steps only, the URL to POST results to

            **Best Practice**: Use `flow_id` + `step_id` + `receipt_token` as an idempotency key.
            `receipt_token` uniquely identifies a work item execution attempt.
            Do NOT depend on `metadata` for core step logic (use `arguments` instead).
          additionalProperties: true
          example:
            flow_id: "wf-123"
            step_id: "text-processor"
            receipt_token: "tok_abc123xyz"
            webhook_url: "http://localhost:8080/webhook/wf-123/text-processor/tok_abc123xyz"

    StepResponse:
      type: object
      required:
        - success
      properties:
        success:
          type: boolean
          description: |
            Whether the step executed successfully.
            - `true`: Step completed successfully (declared outputs are mapped into flow state)
            - `false`: Step failed (check `error` for details)
        outputs:
          type: object
          description: |
            Output values for declared output attributes.

            **Key naming**: Keys should match the step's declared output attributes
            in the step registration. Undeclared keys may be ignored by the engine.

            **Value types**: Outputs can be any JSON-serializable values:
            - Primitives: strings, numbers, booleans
            - Objects: nested structures
            - Arrays: lists of values

            **Required when**: `success: true` (optional if step has no outputs)
          additionalProperties: true
          example:
            processed_text: "HELLO WORLD"
            processing_time_ms: 42
            result_metadata:
              quality_score: 0.95
              confidence: "high"
        error:
          type: string
          description: |
            Human-readable error message for business logic failures.

            **When to use**:
            - The step executed correctly but the business logic failed
            - Examples: Validation errors, invalid input, expected failures

            **Flow behavior**:
            - The step is marked as failed
            - The flow fails if this is a goal step or if dependencies become unreachable
            - Error is logged in flow state

            **Required when**: `success: false`
          example: "Invalid input format: must be one of [uppercase, lowercase, reverse]"

    ErrorResponse:
      type: object
      required:
        - error
      properties:
        error:
          type: string
          description: |
            Error message describing what went wrong.

            This is used for HTTP-level errors (400, 500, 503), NOT for
            business logic errors (which should return 200 with `success: false`).
          example: "Missing required argument: input_text"
        code:
          type: string
          description: |
            Optional error code for programmatic handling.

            Useful for clients to handle different error types without
            parsing error messages.
          example: "MISSING_REQUIRED_ARG"
        details:
          type: object
          description: Additional error context (optional, any structure)
          additionalProperties: true
          example:
            argument_name: "input_text"
            received_arguments: ["format", "timeout_seconds"]

security: []

tags:
  - name: Step Execution
    description: Step execution endpoint contract

x-implementation-notes: |
  ## Implementation Checklist

  When implementing a step endpoint, ensure you:

  1. **Validate required arguments** are present in the request
  2. **Process requests within timeout** configured in step registration
  3. **Return proper HTTP status codes**:
     - 200: Success or business logic error
     - 400: Invalid request format
     - 500: Internal server error
     - 503: Service unavailable
  4. **Use metadata for idempotency**: Use `flow_id` + `step_id` + `receipt_token` as idempotency key
  5. **Distinguish errors from exceptions**:
     - `error`: Recoverable business logic failures
     - `exception`: Critical failures that terminate flow
  6. **Return declared outputs** (keys matching output attributes in registration)
  7. **Handle async operations** properly (return 200 immediately, POST to `webhook_url` when done)

  ## Testing Your Step

  You can test your step implementation with:

  ```bash
  curl -X POST http://localhost:8081/your-step-endpoint \
    -H "Content-Type: application/json" \
    -d '{
      "arguments": {
        "input_arg": "test value"
      },
      "metadata": {
        "flow_id": "test-flow",
        "step_id": "your-step-id",
        "receipt_token": "tok_test123"
      }
    }'
  ```

  ## Example Implementations

  See the `/examples` directory in the Argyll repository for reference
  implementations in various languages and frameworks.
