openapi: 3.0.3
info:
  title: Argyll Engine REST API
  description: |
    REST API for the Argyll orchestrator, providing endpoints for:
    - Registering and managing flow steps
    - Creating and monitoring flows with goal-driven execution
    - Real-time event streaming via WebSocket
    - Health monitoring and system status

    ## Overview

    The Argyll Engine is a goal-driven flow processing system that uses lazy evaluation
    and event sourcing. Steps declare input/output dependencies and the engine orchestrates
    execution based on state availability, only executing the minimal set of steps needed to
    reach a specified goal.

    ## Key Features

    - **Goal-Driven Execution**: Create flows by specifying a goal step; the engine
      automatically determines and executes only the necessary steps
    - **Event Sourcing**: Complete audit trail with Valkey backend for recovery and debugging
    - **Multi-Instance Support**: Horizontal scaling with optimistic concurrency control
    - **Real-Time Updates**: WebSocket streaming for live flow monitoring
    - **Four Step Types**: Sync HTTP, Async HTTP (with webhooks), Script (Ale and Lua), and Flow (sub-flow execution)

    ## Step Implementation

    If you're implementing flow steps (HTTP endpoints or scripts that the engine calls),
    see the separate **Step Interface Contract** specification in `step-interface.yaml`.
    This document describes what you need to consume the engine's REST API.

    ## Authentication

    Currently, the API does not require authentication. For production deployments,
    it's recommended to place the engine behind a reverse proxy with appropriate
    authentication and authorization.

  version: 1.0.0
  contact:
    name: Argyll Engine
    url: https://github.com/kode4food/argyll
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: http://localhost:8080
    description: Local development server

paths:
  /health:
    get:
      summary: Engine Health Check
      description: Returns the health status of the Argyll engine
      operationId: getEngineHealth
      tags:
        - Health
      responses:
        "200":
          description: Engine is healthy
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HealthResponse"

  /engine:
    get:
      summary: Engine State
      description: Get complete engine state including all registered steps and health information
      operationId: getEngineState
      tags:
        - Engine
      responses:
        "200":
          description: Complete engine state
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/EngineStateResponse"

  /engine/step:
    get:
      summary: List Registered Steps
      description: Retrieve all steps currently registered with the engine
      operationId: listSteps
      tags:
        - Steps
      responses:
        "200":
          description: List of registered steps
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/StepsListResponse"
    post:
      summary: Register Step
      description: |
        Register a new flow step with the engine. Steps can be:
        - **Sync**: HTTP endpoints that return results immediately
        - **Async**: HTTP endpoints that return immediately and complete via webhook
        - **Script**: Ale and Lua scripts executed in-engine
        - **Flow**: Sub-flow execution using child flow goals with optional input/output mapping
      operationId: registerStep
      tags:
        - Steps
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/StepRegistration"
            examples:
              syncStep:
                summary: Synchronous HTTP Step
                value:
                  id: "text-processor"
                  name: "Text Processor"
                  type: "sync"
                  attributes:
                    input_text:
                      role: "required"
                      type: "string"
                    processed_text:
                      role: "output"
                      type: "string"
                  http:
                    endpoint: "http://localhost:8081/process-text"
                    health_check: "http://localhost:8081/health"
                    timeout: 30000
              scriptStep:
                summary: Script Step (Ale)
                value:
                  id: "greeter"
                  name: "Greeter"
                  type: "script"
                  attributes:
                    name:
                      role: "required"
                      type: "string"
                    greeting:
                      role: "output"
                      type: "string"
                  script:
                    language: "ale"
                    script: '{:greeting (str "Hello, " name)}'
      responses:
        "201":
          description: Step registered successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/StepRegisteredResponse"
        "400":
          description: Invalid step specification
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "409":
          description: Step already exists with this ID
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /engine/step/{stepId}:
    get:
      summary: Get Step Details
      description: Retrieve details of a specific registered step
      operationId: getStepDetails
      tags:
        - Steps
      parameters:
        - name: stepId
          in: path
          required: true
          description: Unique identifier of the step
          schema:
            type: string
          example: "text-processor"
      responses:
        "200":
          description: Step details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/StepRegistration"
        "404":
          description: Step not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
    put:
      summary: Update Step
      description: |
        Update an existing step registration. Running flows continue using their
        immutable execution plans (step snapshots).
      operationId: updateStep
      tags:
        - Steps
      parameters:
        - name: stepId
          in: path
          required: true
          description: Unique identifier of the step
          schema:
            type: string
          example: "text-processor"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/StepRegistration"
      responses:
        "200":
          description: Step updated successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/StepRegisteredResponse"
        "400":
          description: Invalid step specification or ID mismatch
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: Step not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
    delete:
      summary: Unregister Step
      description: |
        Remove a step from the engine. Running flows that reference this step
        are unaffected as they use immutable execution plan snapshots.
      operationId: unregisterStep
      tags:
        - Steps
      parameters:
        - name: stepId
          in: path
          required: true
          description: Unique identifier of the step
          schema:
            type: string
          example: "text-processor"
      responses:
        "200":
          description: Step unregistered successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MessageResponse"
        "404":
          description: Step not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /engine/health:
    get:
      summary: Step Health Status
      description: Get health status for all registered steps
      operationId: getStepHealthStatus
      tags:
        - Health
      responses:
        "200":
          description: Health status for all steps
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HealthListResponse"

  /engine/health/{stepId}:
    get:
      summary: Step Health Details
      description: Get detailed health information for a specific step
      operationId: getStepHealthDetails
      tags:
        - Health
      parameters:
        - name: stepId
          in: path
          required: true
          description: Unique identifier of the step
          schema:
            type: string
          example: "text-processor"
      responses:
        "200":
          description: Step health details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HealthState"
        "404":
          description: Health information not found for step
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /engine/plan:
    post:
      summary: Create Execution Plan (Preview)
      description: |
        Generate an execution plan for a goal step without starting the flow.
        This is useful for:
        - Previewing which steps will execute
        - Determining required inputs
        - Validating goal step dependencies before execution
      operationId: createExecutionPlan
      tags:
        - Flows
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ExecutionPlanRequest"
            example:
              goals: ["text-processor"]
              init:
                user_id: "john.doe"
      responses:
        "200":
          description: Execution plan generated successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ExecutionPlan"
        "400":
          description: Invalid request (missing goal steps, etc.)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: Goal step not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /engine/flow:
    get:
      summary: List Flows
      description: Retrieve all flows in the system (active, completed, and failed)
      operationId: listFlows
      tags:
        - Flows
      responses:
        "200":
          description: List of flows
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/QueryFlowsItem"
    post:
      summary: Start Flow
      description: |
        Create and start a new flow execution with goal-driven planning.

        The engine will:
        1. Create an execution plan containing only necessary steps
        2. Validate that all required inputs are provided
        3. Start the flow in `active` state
        4. Execute steps in dependency order until the goal is reached
      operationId: createFlow
      tags:
        - Flows
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateFlowRequest"
            example:
              id: "wf-text-processing-001"
              goals: ["text-processor"]
              init:
                input_text: "Hello, Argyll!"
      responses:
        "201":
          description: Flow started successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/FlowStartedResponse"
        "400":
          description: Invalid flow request (missing inputs, invalid goal step, etc.)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "409":
          description: Flow ID already exists
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /engine/flow/query:
    post:
      summary: Query Flows
      description: Query flows using ID prefix, labels, status filters, and pagination
      operationId: queryFlows
      tags:
        - Flows
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/QueryFlowsRequest"
      responses:
        "200":
          description: Query results
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/QueryFlowsResponse"
        "400":
          description: Invalid query request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /engine/flow/{flowId}:
    get:
      summary: Get Flow State
      description: |
        Retrieve the current state of a specific flow, including:
        - Status (active, completed, failed)
        - Execution plan (immutable step snapshots)
        - Current flow attributes
        - Error information (if failed)
      operationId: getFlowState
      tags:
        - Flows
      parameters:
        - name: flowId
          in: path
          required: true
          description: Unique identifier of the flow
          schema:
            type: string
          example: "wf-text-processing-001"
      responses:
        "200":
          description: Complete flow state with execution details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/FlowState"
        "404":
          description: Flow not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /webhook/{flowId}/{stepId}/{token}:
    post:
      summary: Webhook Callback for Async Steps
      description: |
        Receive asynchronous step completion results. This endpoint is called by
        async steps when they complete processing.

        The `token` parameter is a receipt token generated by the engine when the
        async step was started. It validates that the webhook is for a legitimate
        in-progress step execution.
      operationId: handleWebhook
      tags:
        - Webhooks
      parameters:
        - name: flowId
          in: path
          required: true
          description: Flow ID
          schema:
            type: string
          example: "wf-async-processing-001"
        - name: stepId
          in: path
          required: true
          description: Step ID
          schema:
            type: string
          example: "async-processor"
        - name: token
          in: path
          required: true
          description: Receipt token generated by the engine
          schema:
            type: string
          example: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/StepResponse"
            examples:
              success:
                summary: Successful async completion
                value:
                  success: true
                  outputs:
                    processed_data: "Result from async processing"
                    processing_duration_ms: 5000
              failure:
                summary: Async step failure
                value:
                  success: false
                  error: "Processing failed due to invalid input format"
      responses:
        "200":
          description: Webhook processed successfully (empty body)
        "400":
          description: Invalid webhook request, state, or token
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /engine/ws:
    get:
      summary: WebSocket Connection
      description: |
        Establish WebSocket connection for real-time event streaming.

        ## Subscription Protocol

        After connecting, send a subscribe message to receive events:

        ```json
        {
          "type": "subscribe",
          "data": {
            "aggregate_id": ["flow", "my-flow-id"]
          }
        }
        ```

        The server responds with a `subscribed` message containing the current
        state and sequence number:

        ```json
        {
          "type": "subscribed",
          "id": ["flow", "my-flow-id"],
          "data": { ... current flow state ... },
          "sequence": 42
        }
        ```

        After subscription, the server streams events matching your filter.
        The server filters out stale events (sequence < subscription sequence)
        to prevent race conditions.

        ## Aggregate IDs

        - **Engine events**: `["engine"]` - step registration, health changes
        - **Flow events**: `["flow", "flow-id"]` - flow and step execution events

        ## Event Filtering

        You can also filter by event types:

        ```json
        {
          "type": "subscribe",
          "data": {
            "aggregate_id": ["flow", "my-flow-id"],
            "event_types": ["step_completed", "step_failed"]
          }
        }
        ```

        ## Event Message Format

        Events include aggregate ID and sequence for ordering:

        ```json
        {
          "type": "flow_started",
          "timestamp": 1733151600000,
          "id": ["flow", "my-flow-id"],
          "data": { ... event payload ... },
          "sequence": 43
        }
        ```

        **Event Types:**
        - Engine events: step_registered, step_unregistered, step_health_changed
        - Flow events: flow_started, flow_completed, flow_failed,
          step_started, step_completed, step_failed, attribute_set
      operationId: connectWebSocket
      tags:
        - WebSocket
      responses:
        "101":
          description: WebSocket connection established (protocol upgrade)

components:
  schemas:
    HealthResponse:
      type: object
      required:
        - service
        - status
      properties:
        service:
          type: string
          example: "argyll-engine"
        status:
          type: string
          enum: [healthy, unhealthy, unknown]
          description: Overall engine health status
          example: "healthy"
        error:
          type: string
          description: Error message if status is unhealthy

    EngineStateResponse:
      type: object
      required:
        - steps
        - health
        - active
        - deactivated
        - archiving
        - flow_digests
        - attributes
        - last_updated
      properties:
        steps:
          type: object
          description: Map of step ID to step registration
          additionalProperties:
            $ref: "#/components/schemas/StepRegistration"
        health:
          type: object
          description: Map of step ID to health status
          additionalProperties:
            $ref: "#/components/schemas/HealthState"
        active:
          type: object
          description: Map of flow ID to active flow information
          additionalProperties:
            $ref: "#/components/schemas/ActiveFlowInfo"
        deactivated:
          type: array
          description: List of deactivated flows pending archiving
          items:
            $ref: "#/components/schemas/DeactivatedFlowInfo"
        archiving:
          type: object
          description: Map of flow ID to archiving lease timestamp
          additionalProperties:
            type: string
            format: date-time
        flow_digests:
          type: object
          description: Map of flow ID to digest summary
          additionalProperties:
            $ref: "#/components/schemas/FlowDigest"
        attributes:
          type: object
          description: Engine-level attribute dependency graph
          additionalProperties:
            $ref: "#/components/schemas/Dependencies"
        last_updated:
          type: string
          format: date-time
          description: Timestamp of last engine state update

    HealthListResponse:
      type: object
      required:
        - health
        - count
      properties:
        health:
          type: object
          description: Map of step ID to health status
          additionalProperties:
            $ref: "#/components/schemas/HealthState"
        count:
          type: integer
          description: Number of steps with health information
          example: 7

    HealthState:
      type: object
      required:
        - status
      properties:
        status:
          type: string
          enum: [healthy, unhealthy, unknown]
          description: |
            - `healthy`: Step's health check passed
            - `unhealthy`: Step's health check failed
            - `unknown`: Health check has not been performed yet
        error:
          type: string
          description: Error message if status is unhealthy
          example: "Connection refused"

    StepRegistration:
      type: object
      required:
        - id
        - name
        - type
      properties:
        id:
          type: string
          description: Unique identifier for this step
          example: "text-processor"
        name:
          type: string
          description: Human-readable name
          example: "Text Processor"
        type:
          type: string
          enum: ["sync", "async", "script", "flow"]
          description: |
            - `sync`: HTTP endpoint that returns results immediately
            - `async`: HTTP endpoint that returns immediately and completes via webhook
            - `script`: Ale or Lua script executed in-engine
            - `flow`: Sub-flow executed by the engine using child flow goals
          example: "sync"
        attributes:
          type: object
          description: Step attributes (inputs and outputs) mapped by attribute name
          additionalProperties:
            $ref: "#/components/schemas/AttributeSpec"
          example:
            input_text:
              role: "required"
              type: "string"
            user_email:
              role: "required"
              type: "string"
              mapping:
                name: "email"
            optional_field:
              role: "optional"
              type: "string"
              default: '"default_value"'
            const_field:
              role: "const"
              type: "string"
              default: '"fixed_value"'
            processed_text:
              role: "output"
              type: "string"
            user_data:
              role: "output"
              type: "object"
              mapping:
                script:
                  language: "jpath"
                  script: "$.response.data"
        labels:
          type: object
          description: Optional labels for categorization and discovery
          additionalProperties:
            type: string
        predicate:
          $ref: "#/components/schemas/ScriptConfig"
          description: Optional script-based predicate for conditional execution
        memoizable:
          type: boolean
          default: false
          description: |
            Enable result caching (memoization) for this step.
            When enabled, the engine maintains a cache of (step definition, inputs) â†’ outputs mappings.
            Before execution, the cache is checked using a deterministic key based on the step's functional definition and input arguments.
            Cache hits return cached outputs without re-executing the step. Only successful executions are cached.
            The cache is global, in-memory, thread-safe, and uses LRU eviction.
          example: true
        http:
          $ref: "#/components/schemas/HttpConfig"
        flow:
          $ref: "#/components/schemas/FlowConfig"
        script:
          $ref: "#/components/schemas/ScriptConfig"
        work_config:
          $ref: "#/components/schemas/WorkConfig"

    AttributeSpec:
      type: object
      description: Attribute specification defining input or output for a step
      required:
        - role
      properties:
        role:
          type: string
          description: |
            Attribute role:
            - `required`: Input that must be available before execution
            - `optional`: Input with default value or timeout
            - `const`: Input fixed to a default value
            - `output`: Value produced by step execution
          enum:
            - required
            - optional
            - const
            - output
          example: "required"
        type:
          type: string
          description: |
            Type hint for validation and documentation:
            - `string`, `number`, `boolean`, `object`, `array`, `null`, `any`
          enum:
            - string
            - number
            - boolean
            - object
            - array
            - null
            - any
          example: "string"
        default:
          type: string
          description: |
            Default value as JSON string (for optional and const attributes).
            Must be valid JSON matching the specified type.
          example: '"default_value"'
        for_each:
          type: boolean
          description: |
            If true, this step will execute once for each element in an array input.
            Only allowed for input attributes (required/optional) with array type.
          default: false
          example: false
        mapping:
          $ref: "#/components/schemas/AttributeMapping"

    AttributeMapping:
      type: object
      description: |
        Defines parameter name mapping and value transformation for attributes.
        Allows renaming parameters between flow state and service interfaces,
        and transforming values using scripts (JSONPath for queries, Lua/Ale for logic).

        At least one of `name` or `script` must be provided.
        Not allowed on const attributes.
      properties:
        name:
          type: string
          description: |
            Service-level parameter name (inner name) - the key used in the service request/response.
            If not specified, the attribute name (outer name) is used.

            For inputs: reads from flow state using attribute name, sends to service using this name.
            For outputs: reads from service response using this name, stores in flow state using attribute name.
          example: "user_email"
        script:
          $ref: "#/components/schemas/ScriptConfig"
      example:
        name: "email"
        script:
          language: "jpath"
          script: "$.user.email"

    HttpConfig:
      type: object
      description: Configuration for HTTP-based steps (sync/async)
      required:
        - endpoint
        - timeout
      properties:
        endpoint:
          type: string
          format: uri
          description: HTTP endpoint URL
          example: "http://localhost:8081/process-text"
        health_check:
          type: string
          format: uri
          description: Optional health check endpoint
          example: "http://localhost:8081/health"
        timeout:
          type: integer
          format: int64
          description: Timeout in milliseconds for HTTP requests
          example: 30000

    ScriptConfig:
      type: object
      description: |
        Configuration for script-based steps or attribute mappings.

        For step execution (`type: script`), `ale` and `lua` are supported.
        For predicates and attribute mappings, all registered languages are valid
        (`ale`, `lua`, `jpath` in the default engine).
      required:
        - language
        - script
      properties:
        language:
          type: string
          enum: ["ale", "lua", "jpath"]
          description: |
            Script language:
            - `ale`: Ale expressions
            - `lua`: Lua scripts
            - `jpath`: JSONPath query expressions
          example: "ale"
        script:
          type: string
          description: |
            The script code to execute.

            For JSONPath: A query string like `$.user.email` or `$.data[0].value`
            For Ale/Lua: The complete script code
          example: '{:greeting (str "Hello, " name)}'

    FlowConfig:
      type: object
      description: Configuration for flow-based steps (sub-flows)
      required:
        - goals
      properties:
        goals:
          type: array
          description: Goal step IDs for the child flow
          items:
            type: string
          minItems: 1
          example: ["child-goal"]
        input_map:
          type: object
          description: Optional mapping from parent input attribute names to child input names
          additionalProperties:
            type: string
          example:
            parent_input: "child_input"
        output_map:
          type: object
          description: Optional mapping from child output names to parent output attribute names
          additionalProperties:
            type: string
          example:
            child_output: "parent_output"

    WorkConfig:
      type: object
      description: Configuration for step execution behavior
      properties:
        max_retries:
          type: integer
          description: Maximum number of retries on failure
          example: 3
        backoff:
          type: integer
          format: int64
          description: Initial backoff delay in milliseconds
          example: 1000
        max_backoff:
          type: integer
          format: int64
          description: Maximum backoff delay in milliseconds
          example: 30000
        backoff_type:
          type: string
          enum: ["fixed", "linear", "exponential"]
          description: Backoff strategy
          example: "exponential"
        parallelism:
          type: integer
          description: Maximum parallel executions for for_each steps
          example: 10

    StepRegisteredResponse:
      type: object
      required:
        - message
        - step
      properties:
        message:
          type: string
          example: "Step registered"
        step:
          $ref: "#/components/schemas/StepRegistration"

    StepsListResponse:
      type: object
      required:
        - steps
        - count
      properties:
        steps:
          type: array
          items:
            $ref: "#/components/schemas/StepRegistration"
        count:
          type: integer
          description: Total number of registered steps
          example: 12

    ExecutionPlanRequest:
      type: object
      required:
        - goals
      properties:
        goals:
          type: array
          description: Array of goal step IDs (typically one, but multiple supported)
          items:
            type: string
          minItems: 1
          example: ["text-processor"]
        init:
          type: object
          description: Initial flow state (arguments/attributes)
          additionalProperties: true
          example:
            user_id: "john.doe"

    ExecutionPlan:
      type: object
      required:
        - goals
        - required
        - steps
        - attributes
      properties:
        goals:
          type: array
          description: Goal step IDs for this plan
          items:
            type: string
          example: ["text-processor"]
        required:
          type: array
          description: Required inputs that must be provided in init
          items:
            type: string
          example: ["input_text"]
        steps:
          type: object
          description: Map of step ID to step information (immutable snapshots)
          additionalProperties:
            $ref: "#/components/schemas/StepInfo"
        attributes:
          type: object
          description: Map of attribute names to their provider/consumer dependencies
          additionalProperties:
            $ref: "#/components/schemas/Dependencies"
        excluded:
          $ref: "#/components/schemas/ExcludedSteps"
          description: Excluded steps grouped by reason

    ExcludedSteps:
      type: object
      properties:
        missing:
          type: object
          description: Steps excluded due to missing required inputs
          additionalProperties:
            type: array
            items:
              type: string
        satisfied:
          type: object
          description: Steps excluded due to init-provided outputs
          additionalProperties:
            type: array
            items:
              type: string

    StepInfo:
      type: object
      required:
        - step
      properties:
        step:
          $ref: "#/components/schemas/StepRegistration"
          description: The step definition snapshot

    Dependencies:
      type: object
      required:
        - providers
        - consumers
      properties:
        providers:
          type: array
          description: Step IDs that provide/produce this attribute
          items:
            type: string
          example: ["data-fetcher"]
        consumers:
          type: array
          description: Step IDs that consume/require this attribute
          items:
            type: string
          example: ["data-processor", "data-validator"]

    CreateFlowRequest:
      type: object
      required:
        - id
        - goals
      properties:
        id:
          type: string
          description: Unique flow identifier
          example: "wf-text-processing-001"
        goals:
          type: array
          description: Goal step IDs (typically one, but multiple supported)
          items:
            type: string
          minItems: 1
          example: ["text-processor"]
        init:
          type: object
          description: Initial flow state providing required inputs
          additionalProperties: true
          example:
            input_text: "Hello, Argyll!"
        labels:
          type: object
          description: Optional labels for the flow
          additionalProperties:
            type: string

    FlowStartedResponse:
      type: object
      required:
        - flow_id
      properties:
        message:
          type: string
          example: "Flow started successfully"
        flow_id:
          type: string
          example: "wf-text-processing-001"

    QueryFlowsResponse:
      type: object
      required:
        - flows
        - count
      properties:
        flows:
          type: array
          items:
            $ref: "#/components/schemas/QueryFlowsItem"
        count:
          type: integer
          description: Number of flows returned in this response
          example: 3
        total:
          type: integer
          description: Total number of flows available
          example: 120
        has_more:
          type: boolean
          description: True when more flows are available after this page
          example: true
        next_cursor:
          type: string
          description: Cursor token for the next page
          example: "eyJncm91cCI6MCwicmVjZW50IjoxNzA3MDAwMDAwMDAwMDAwMDAwLCJpZCI6IndmLTAwMiJ9"

    QueryFlowsItem:
      type: object
      required:
        - id
      properties:
        id:
          type: string
          description: Flow identifier
          example: "wf-text-processing-001"
        digest:
          $ref: "#/components/schemas/FlowDigest"

    FlowDigest:
      type: object
      required:
        - status
        - created_at
      properties:
        status:
          type: string
          enum: [active, completed, failed]
          description: |
            - `active`: Flow is currently executing
            - `completed`: Flow completed successfully
            - `failed`: Flow failed with an error
          example: "active"
        created_at:
          type: string
          format: date-time
          description: Flow creation timestamp
        completed_at:
          type: string
          format: date-time
          description: Flow completion timestamp (if completed or failed)
        labels:
          type: object
          description: Flow labels
          additionalProperties:
            type: string
        error:
          type: string
          description: Error message if status is failed

    QueryFlowsRequest:
      type: object
      properties:
        id_prefix:
          type: string
          description: Flow ID prefix to match
          example: "wf-"
        labels:
          type: object
          description: Labels to match (ANDed)
          additionalProperties:
            type: string
          example:
            env: "prod"
        statuses:
          type: array
          description: Flow statuses to include
          items:
            type: string
            enum: [active, completed, failed]
        limit:
          type: integer
          description: Maximum number of flows to return
          minimum: 0
          example: 1000
        cursor:
          type: string
          description: Cursor token from previous page
        sort:
          type: string
          enum: [recent_desc, recent_asc]
          description: Sort order by recency within status grouping
          example: "recent_desc"

    FlowState:
      type: object
      required:
        - id
        - status
        - created_at
        - last_updated
        - plan
        - attributes
        - executions
      properties:
        id:
          type: string
          description: Flow identifier
          example: "wf-text-processing-001"
        status:
          type: string
          enum: [active, completed, failed]
          description: Current flow status
          example: "active"
        created_at:
          type: string
          format: date-time
          description: Flow creation timestamp
        completed_at:
          type: string
          format: date-time
          description: Flow completion timestamp (if completed or failed)
        last_updated:
          type: string
          format: date-time
          description: Timestamp of last state update
        plan:
          $ref: "#/components/schemas/ExecutionPlan"
          description: Immutable execution plan for this flow
        attributes:
          type: object
          description: Map of attribute name to attribute value with provenance
          additionalProperties:
            $ref: "#/components/schemas/AttributeValue"
        executions:
          type: object
          description: Map of step ID to execution state
          additionalProperties:
            $ref: "#/components/schemas/ExecutionState"
        error:
          type: string
          description: Error message if status is failed
          example: "Step execution failed: connection timeout"

    ActiveFlowInfo:
      type: object
      required:
        - started_at
        - last_active
      properties:
        parent_flow_id:
          type: string
          description: Parent flow ID for child flows
          example: "wf-parent-001"
        started_at:
          type: string
          format: date-time
          description: When the flow started executing
        last_active:
          type: string
          format: date-time
          description: Last time the flow had activity

    DeactivatedFlowInfo:
      type: object
      required:
        - flow_id
        - deactivated_at
      properties:
        flow_id:
          type: string
          description: Flow identifier
          example: "wf-text-processing-001"
        parent_flow_id:
          type: string
          description: Parent flow ID for child flows
          example: "wf-parent-001"
        deactivated_at:
          type: string
          format: date-time
          description: When the flow was deactivated

    AttributeValue:
      type: object
      required:
        - value
      properties:
        value:
          description: The attribute value (can be any JSON type)
        step:
          type: string
          description: ID of the step that produced this value
          example: "data-fetcher"

    ExecutionState:
      type: object
      required:
        - status
        - started_at
        - inputs
      properties:
        status:
          type: string
          enum: [pending, active, completed, skipped, failed]
          description: Current execution status
          example: "completed"
        started_at:
          type: string
          format: date-time
          description: When the step execution started
        completed_at:
          type: string
          format: date-time
          description: When the step execution completed (if finished)
        inputs:
          type: object
          description: Input arguments provided to the step
          additionalProperties: true
        outputs:
          type: object
          description: Output values produced by the step
          additionalProperties: true
        error:
          type: string
          description: Error message if status is failed
        duration:
          type: integer
          format: int64
          description: Execution duration in milliseconds
          example: 1234
        work_items:
          type: object
          description: Map of token to work item state (for for_each steps)
          additionalProperties:
            $ref: "#/components/schemas/WorkState"

    WorkState:
      type: object
      required:
        - status
        - started_at
        - inputs
      properties:
        status:
          type: string
          enum: [pending, active, succeeded, failed, not_completed]
          description: Current work item status
          example: "succeeded"
        started_at:
          type: string
          format: date-time
          description: When the work item started
        completed_at:
          type: string
          format: date-time
          description: When the work item completed (if finished)
        inputs:
          type: object
          description: Input arguments for this work item
          additionalProperties: true
        outputs:
          type: object
          description: Output values from this work item
          additionalProperties: true
        error:
          type: string
          description: Error message if status is failed
        retry_count:
          type: integer
          description: Number of retry attempts made
          example: 2
        next_retry_at:
          type: string
          format: date-time
          description: When the next retry is scheduled

    StepResponse:
      type: object
      required:
        - success
      description: Response from a step execution (used for webhook callbacks)
      properties:
        success:
          type: boolean
          description: Whether the step executed successfully
        outputs:
          type: object
          description: Output values for declared step output attributes
          additionalProperties: true
          example:
            processed_text: "HELLO WORLD"
            processing_time_ms: 42
        error:
          type: string
          description: Error message if success is false
          example: "Invalid input format"

    MessageResponse:
      type: object
      required:
        - message
      properties:
        message:
          type: string
          example: "Operation completed successfully"

    ErrorResponse:
      type: object
      required:
        - error
      properties:
        error:
          type: string
          description: Error message
          example: "Step not found"
        status:
          type: integer
          description: HTTP status code
          example: 404
        details:
          type: string
          description: Additional error details

security: []

tags:
  - name: Engine
    description: Engine state and status
  - name: Steps
    description: Step registration and management
  - name: Health
    description: Health monitoring for steps and engine
  - name: Flows
    description: Flow creation, execution, and monitoring
  - name: Webhooks
    description: Webhook callbacks for async steps
  - name: WebSocket
    description: Real-time event streaming
